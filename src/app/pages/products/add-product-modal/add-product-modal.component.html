@if (isOpen) {
  <div
    data-modal-backdrop
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"
    (click)="onBackdropClick($event)"
    role="dialog"
    aria-modal="true"
    aria-labelledby="modal-title"
  >
    <div
      class="flex max-h-[90vh] w-full max-w-2xl flex-col rounded-xl bg-white shadow-xl"
      (click)="$event.stopPropagation()"
    >
      <div class="flex shrink-0 items-center justify-between border-b border-gray-200 px-6 py-4">
        <h2 id="modal-title" class="text-lg font-semibold text-gray-900">Add listing</h2>
        <button
          type="button"
          (click)="emitClose()"
          class="rounded-lg p-1 text-gray-400 hover:bg-gray-100 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500"
          aria-label="Close"
        >
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="flex min-h-0 flex-1 flex-col">
        <div class="min-h-0 flex-1 overflow-y-auto px-6 py-4">
          <div class="space-y-6">
            <!-- Basic -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">Basic info</h3>
              <div class="space-y-3">
                <div>
                  <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                  <input
                    id="title"
                    type="text"
                    formControlName="title"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="e.g. Stainless steel wine press"
                  />
                  @if (form.get('title')?.invalid && form.get('title')?.touched) {
                    <p class="mt-1 text-sm text-red-600">Title is required (2–200 characters).</p>
                  }
                </div>
                <div>
                  <label for="slug" class="block text-sm font-medium text-gray-700">Slug (optional)</label>
                  <input
                    id="slug"
                    type="text"
                    formControlName="slug"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="url-friendly-slug"
                  />
                </div>
                <div>
                  <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                  <textarea
                    id="description"
                    formControlName="description"
                    rows="3"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="Describe the item"
                  ></textarea>
                  @if (form.get('description')?.invalid && form.get('description')?.touched) {
                    <p class="mt-1 text-sm text-red-600">Description is required.</p>
                  }
                </div>
                <div>
                  <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
                  <select
                    id="type"
                    formControlName="type"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                  >
                    @for (opt of listingTypes; track opt.value) {
                      <option [value]="opt.value">{{ opt.label }}</option>
                    }
                  </select>
                </div>
              </div>
            </section>

            <!-- Category -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">Category</h3>
              <div formGroupName="category" class="grid grid-cols-2 gap-3">
                <div>
                  <label for="categoryName" class="block text-sm font-medium text-gray-700">Category name</label>
                  <input
                    id="categoryName"
                    type="text"
                    formControlName="name"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="e.g. Wine press"
                  />
                  @if (form.get('category.name')?.invalid && form.get('category.name')?.touched) {
                    <p class="mt-1 text-sm text-red-600">Required.</p>
                  }
                </div>
                <div>
                  <label for="categorySlug" class="block text-sm font-medium text-gray-700">Category slug</label>
                  <input
                    id="categorySlug"
                    type="text"
                    formControlName="slug"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="wine-press"
                  />
                  @if (form.get('category.slug')?.invalid && form.get('category.slug')?.touched) {
                    <p class="mt-1 text-sm text-red-600">Required.</p>
                  }
                </div>
              </div>
            </section>

            <!-- Pricing -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">Pricing</h3>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label for="price" class="block text-sm font-medium text-gray-700">Price</label>
                  <input
                    id="price"
                    type="number"
                    formControlName="price"
                    step="0.01"
                    min="0"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="0.00"
                  />
                  @if (form.get('price')?.invalid && form.get('price')?.touched) {
                    <p class="mt-1 text-sm text-red-600">Valid price is required.</p>
                  }
                </div>
                <div>
                  <label for="currency" class="block text-sm font-medium text-gray-700">Currency</label>
                  <select
                    id="currency"
                    formControlName="currency"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                  >
                    @for (c of currencies; track c.value) {
                      <option [value]="c.value">{{ c.label }}</option>
                    }
                  </select>
                </div>
                <div>
                  <label for="priceType" class="block text-sm font-medium text-gray-700">Price type</label>
                  <select
                    id="priceType"
                    formControlName="priceType"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                  >
                    @for (p of priceTypes; track p.value) {
                      <option [value]="p.value">{{ p.label }}</option>
                    }
                  </select>
                </div>
                @if (isRent) {
                  <div>
                    <label for="rentPeriod" class="block text-sm font-medium text-gray-700">Rent period</label>
                    <select
                      id="rentPeriod"
                      formControlName="rentPeriod"
                      class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    >
                      <option value="">Select period</option>
                      @for (r of rentPeriods; track r.value) {
                        <option [value]="r.value">{{ r.label }}</option>
                      }
                    </select>
                    @if (form.get('rentPeriod')?.invalid && form.get('rentPeriod')?.touched) {
                      <p class="mt-1 text-sm text-red-600">Required for rent.</p>
                    }
                  </div>
                }
              </div>
            </section>

            <!-- Location -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">Location</h3>
              <div formGroupName="location" class="grid grid-cols-2 gap-3">
                <div>
                  <label for="region" class="block text-sm font-medium text-gray-700">Region</label>
                  <input
                    id="region"
                    type="text"
                    formControlName="region"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="e.g. Kakheti"
                  />
                  @if (form.get('location.region')?.invalid && form.get('location.region')?.touched) {
                    <p class="mt-1 text-sm text-red-600">Required.</p>
                  }
                </div>
                <div>
                  <label for="city" class="block text-sm font-medium text-gray-700">City</label>
                  <input
                    id="city"
                    type="text"
                    formControlName="city"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="e.g. Telavi"
                  />
                  @if (form.get('location.city')?.invalid && form.get('location.city')?.touched) {
                    <p class="mt-1 text-sm text-red-600">Required.</p>
                  }
                </div>
              </div>
            </section>

            <!-- Specifications -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">Specifications</h3>
              <div formGroupName="specifications" class="grid grid-cols-2 gap-3">
                <div>
                  <label for="condition" class="block text-sm font-medium text-gray-700">Condition</label>
                  <select
                    id="condition"
                    formControlName="condition"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                  >
                    <option value="">—</option>
                    @for (cond of conditions; track cond.value) {
                      <option [value]="cond.value">{{ cond.label }}</option>
                    }
                  </select>
                </div>
                <div>
                  <label for="brand" class="block text-sm font-medium text-gray-700">Brand</label>
                  <input
                    id="brand"
                    type="text"
                    formControlName="brand"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="Optional"
                  />
                </div>
                <div>
                  <label for="model" class="block text-sm font-medium text-gray-700">Model</label>
                  <input
                    id="model"
                    type="text"
                    formControlName="model"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="Optional"
                  />
                </div>
                <div>
                  <label for="year" class="block text-sm font-medium text-gray-700">Year</label>
                  <input
                    id="year"
                    type="number"
                    formControlName="year"
                    min="1900"
                    max="2100"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="Optional"
                  />
                </div>
                <div>
                  <label for="capacity" class="block text-sm font-medium text-gray-700">Capacity</label>
                  <input
                    id="capacity"
                    type="text"
                    formControlName="capacity"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="e.g. 500 L"
                  />
                </div>
                <div>
                  <label for="power" class="block text-sm font-medium text-gray-700">Power</label>
                  <input
                    id="power"
                    type="text"
                    formControlName="power"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="e.g. 2.5 kW"
                  />
                </div>
              </div>
            </section>

            <!-- Media -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">Media</h3>
              <div class="space-y-3">
                <div>
                  <label for="images" class="block text-sm font-medium text-gray-700">Image URLs (one per line)</label>
                  <textarea
                    id="images"
                    formControlName="images"
                    rows="3"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="https://..."
                  ></textarea>
                </div>
                <div>
                  <label for="thumbnail" class="block text-sm font-medium text-gray-700">Thumbnail URL (optional)</label>
                  <input
                    id="thumbnail"
                    type="text"
                    formControlName="thumbnail"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="Uses first image if empty"
                  />
                </div>
              </div>
            </section>

            <!-- SEO -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">SEO (optional)</h3>
              <div class="space-y-3">
                <div>
                  <label for="seoTitle" class="block text-sm font-medium text-gray-700">SEO title (max 70 chars)</label>
                  <input
                    id="seoTitle"
                    type="text"
                    formControlName="seoTitle"
                    maxlength="70"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="Optional"
                  />
                </div>
                <div>
                  <label for="seoDescription" class="block text-sm font-medium text-gray-700">SEO description (max 160 chars)</label>
                  <textarea
                    id="seoDescription"
                    formControlName="seoDescription"
                    rows="2"
                    maxlength="160"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="Optional"
                  ></textarea>
                </div>
              </div>
            </section>
          </div>
        </div>

        <div class="shrink-0 border-t border-gray-200 px-6 py-4">
          <div class="flex justify-end gap-3">
            <button
              type="button"
              (click)="emitClose()"
              class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
            >
              Save listing
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
}
