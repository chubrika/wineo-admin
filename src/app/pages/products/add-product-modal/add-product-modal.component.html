@if (isOpen()) {
  <div
    data-modal-backdrop
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"
    (click)="onBackdropClick($event)"
    role="dialog"
    aria-modal="true"
    aria-labelledby="modal-title"
  >
    <div
      class="flex max-h-[90vh] w-full max-w-2xl flex-col rounded-xl bg-white shadow-xl"
      (click)="$event.stopPropagation()"
    >
      <div class="flex shrink-0 items-center justify-between border-b border-gray-200 px-6 py-4">
        <h2 id="modal-title" class="text-lg font-semibold text-gray-900">{{ editListing() ? 'პროდუქტის რედაქტირება' : 'პროდუქტის დამატება' }}</h2>
        <button
          type="button"
          (click)="emitClose()"
          class="rounded-lg p-1 text-gray-400 hover:bg-gray-100 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500"
          aria-label="Close"
        >
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="flex min-h-0 flex-1 flex-col">
        <div class="min-h-0 flex-1 overflow-y-auto px-6 py-4">
          <div class="space-y-6">
            <!-- Basic -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">ძირითადი ინფორმაცია</h3>
              <div class="space-y-3">
                <div>
                  <label for="title" class="block text-sm font-medium text-gray-700">სათაური</label>
                  <input
                    id="title"
                    type="text"
                    formControlName="title"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="მაგ. ყურძნის პრესი"
                  />
                  @if (form.get('title')?.invalid && form.get('title')?.touched) {
                    <p class="mt-1 text-sm text-red-600">სათაური სავალდებულოა (2–200 სიმბოლო).</p>
                  }
                </div>
                <div>
                  <label for="description" class="block text-sm font-medium text-gray-700">აღწერა</label>
                  <textarea
                    id="description"
                    formControlName="description"
                    rows="3"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="აღწერა სავალდებულოა"
                  ></textarea>
                  @if (form.get('description')?.invalid && form.get('description')?.touched) {
                    <p class="mt-1 text-sm text-red-600">Description is required.</p>
                  }
                </div>
                <div>
                  <span class="block text-sm font-medium text-gray-700">ტიპი</span>
                  <div
                    role="group"
                    aria-label="Listing type"
                    class="mt-1 inline-flex rounded-lg border border-gray-300 p-0.5 bg-gray-100"
                  >
                    @for (opt of listingTypes; track opt.value) {
                      <button
                        type="button"
                        (click)="form.get('type')?.setValue(opt.value)"
                        class="rounded-md cursor-pointer px-4 py-2 text-sm font-medium transition-colors hover:bg-gray-300 focus:outline-none"
                        [class.bg-green-600]="form.get('type')?.value === opt.value"
                        [class.text-white]="form.get('type')?.value === opt.value"
                        [class.shadow-sm]="form.get('type')?.value === opt.value"
                        [class.text-gray-600]="form.get('type')?.value !== opt.value"
                      >
                        {{ opt.label }}
                      </button>
                    }
                  </div>
                </div>
              </div>
            </section>

            <!-- Category -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">კატეგორიები</h3>
              <div>
                <label for="categoryId" class="block text-sm font-medium text-gray-700">კატეგორია</label>
                <select
                  id="categoryId"
                  formControlName="categoryId"
                  class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                >
                  <option [ngValue]="null">— Select category —</option>
                  @for (cat of categoryOptions; track cat.id) {
                    <option [ngValue]="cat.id">{{ cat.name }}</option>
                  }
                </select>
                @if (form.get('categoryId')?.invalid && form.get('categoryId')?.touched) {
                  <p class="mt-1 text-sm text-red-600">Category is required.</p>
                }
              </div>
              @if (loadingFilters) {
                <p class="mt-2 text-sm text-gray-500">Loading filters…</p>
              }
              @if (categoryFilters.length > 0) {
                <div [formGroup]="attributeForm" class="mt-4 space-y-3">
                  <h4 class="text-sm font-medium text-gray-700">Attributes</h4>
                  @for (f of categoryFilters; track f.id) {
                    <div>
                      <label [for]="'attr-' + f.id" class="block text-sm font-medium text-gray-700">
                        {{ f.name }}
                        @if (f.unit) {
                          <span class="font-normal text-gray-500">({{ f.unit }})</span>
                        }
                        @if (f.isRequired) {
                          <span class="text-red-600">*</span>
                        }
                      </label>
                      @switch (f.type) {
                        @case ('select') {
                          <select
                            [id]="'attr-' + f.id"
                            [formControlName]="f.id"
                            class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                          >
                            <option [ngValue]="null">—</option>
                            @for (opt of f.options; track opt) {
                              <option [ngValue]="opt">{{ opt }}</option>
                            }
                          </select>
                        }
                        @case ('number') {
                          <input
                            [id]="'attr-' + f.id"
                            type="number"
                            [formControlName]="f.id"
                            class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                            [placeholder]="f.unit || ''"
                          />
                        }
                        @case ('checkbox') {
                          <div class="mt-1">
                            <input
                              [id]="'attr-' + f.id"
                              type="checkbox"
                              [formControlName]="f.id"
                              class="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-500"
                            />
                          </div>
                        }
                        @default {
                          <input
                            [id]="'attr-' + f.id"
                            type="text"
                            [formControlName]="f.id"
                            class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                            [placeholder]="f.type === 'range' ? 'e.g. 10 - 20' : ''"
                          />
                        }
                      }
                    </div>
                  }
                </div>
              }
            </section>

            <!-- Pricing -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">ღირებულება</h3>
              <div class="space-y-4">
                <div>
                  <span class="block text-sm font-medium text-gray-700">ფასის ტიპი</span>
                  <div
                    role="group"
                    aria-label="Price type"
                    class="mt-1 inline-flex rounded-lg border border-gray-300 p-0.5 bg-gray-100"
                  >
                    @for (p of priceTypes; track p.value) {
                      <button
                        type="button"
                        (click)="form.get('priceType')?.setValue(p.value)"
                        class="rounded-md px-4 py-2 text-sm font-medium transition-colors hover:bg-gray-50 focus:outline-none cursor-pointer"
                        [class.bg-green-600]="form.get('priceType')?.value === p.value"
                        [class.text-white]="form.get('priceType')?.value === p.value"
                        [class.shadow-sm]="form.get('priceType')?.value === p.value"
                        [class.text-gray-600]="form.get('priceType')?.value !== p.value"
                      >
                        {{ p.label }}
                      </button>
                    }
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label for="price" class="block text-sm font-medium text-gray-700">ფასი</label>
                    <input
                      id="price"
                      type="number"
                      formControlName="price"
                      step="0.01"
                      min="0"
                      class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
                      placeholder="0.00"
                    />
                    @if (form.get('price')?.invalid && form.get('price')?.touched) {
                      <p class="mt-1 text-sm text-red-600">Valid price is required.</p>
                    }
                  </div>
                  <div>
                    <span class="block text-sm font-medium text-gray-700">ვალუტა</span>
                    <div
                      role="group"
                      aria-label="Currency"
                      class="mt-1 inline-flex rounded-lg border border-gray-300 p-0.5 bg-gray-100"
                      [class.opacity-60]="form.get('priceType')?.value === 'negotiable'"
                      [class.pointer-events-none]="form.get('priceType')?.value === 'negotiable'"
                    >
                      @for (c of currencies; track c.value) {
                        <button
                          type="button"
                          (click)="form.get('currency')?.setValue(c.value)"
                          class="rounded-md cursor-pointer px-4 py-2 text-sm font-medium transition-colors hover:bg-gray-300 focus:outline-none"
                          [class.bg-green-600]="form.get('currency')?.value === c.value"
                          [class.text-white]="form.get('currency')?.value === c.value"
                          [class.shadow-sm]="form.get('currency')?.value === c.value"
                          [class.text-gray-600]="form.get('currency')?.value !== c.value"
                        >
                          {{ c.label }}
                        </button>
                      }
                    </div>
                  </div>
                </div>
                @if (isRent) {
                  <div>
                    <label for="rentPeriod" class="block text-sm font-medium text-gray-700">Rent period</label>
                    <select
                      id="rentPeriod"
                      formControlName="rentPeriod"
                      class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    >
                      <option value="">Select period</option>
                      @for (r of rentPeriods; track r.value) {
                        <option [value]="r.value">{{ r.label }}</option>
                      }
                    </select>
                    @if (form.get('rentPeriod')?.invalid && form.get('rentPeriod')?.touched) {
                      <p class="mt-1 text-sm text-red-600">Required for rent.</p>
                    }
                  </div>
                }
              </div>
            </section>

            <!-- Location -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">მდებარეობა</h3>
              <div formGroupName="location" class="grid grid-cols-2 gap-3">
                <div>
                  <label for="location-regionId" class="block text-sm font-medium text-gray-700">რეგიონი</label>
                  <select
                    id="location-regionId"
                    formControlName="regionId"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                  >
                    <option value="">— აირჩიეთ რეგიონი —</option>
                    @for (r of regionOptions; track r.id) {
                      <option [value]="r.id">{{ r.label }}</option>
                    }
                  </select>
                  @if (form.get('location.regionId')?.invalid && form.get('location.regionId')?.touched) {
                    <p class="mt-1 text-sm text-red-600">რეგიონის არჩევა სავალდებულოა.</p>
                  }
                </div>
                <div>
                  <label for="location-cityId" class="block text-sm font-medium text-gray-700">ქალაქი</label>
                  <select
                    id="location-cityId"
                    formControlName="cityId"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
                    [disabled]="!form.get('location.regionId')?.value || loadingCities"
                  >
                    <option value="">— აირჩიეთ ქალაქი —</option>
                    @for (c of cityOptions; track c.id) {
                      <option [value]="c.id">{{ c.label }}</option>
                    }
                  </select>
                  @if (loadingCities) {
                    <p class="mt-1 text-xs text-gray-500">ქალაქების ჩატვირთვა…</p>
                  }
                  @if (form.get('location.cityId')?.invalid && form.get('location.cityId')?.touched) {
                    <p class="mt-1 text-sm text-red-600">ქალაქის არჩევა სავალდებულოა.</p>
                  }
                </div>
              </div>
            </section>

            <!-- Specifications: only condition; other attributes come from category filters -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">მდგომარეობა</h3>
              <div formGroupName="specifications">
                <div
                  role="group"
                  aria-label="Condition"
                  class="mt-1 inline-flex rounded-lg border border-gray-300 p-0.5 bg-gray-100"
                >
                  @for (cond of conditions; track cond.value) {
                    <button
                      type="button"
                      (click)="form.get('specifications.condition')?.setValue(cond.value)"
                      class="rounded-md cursor-pointer px-4 py-2 text-sm font-medium transition-colors hover:bg-gray-300 focus:outline-none"
                      [class.bg-green-600]="form.get('specifications.condition')?.value === cond.value"
                      [class.text-white]="form.get('specifications.condition')?.value === cond.value"
                      [class.shadow-sm]="form.get('specifications.condition')?.value === cond.value"
                      [class.text-gray-600]="form.get('specifications.condition')?.value !== cond.value"
                    >
                      {{ cond.label }}
                    </button>
                  }
                </div>
              </div>
            </section>

            <!-- Media -->
            <section>
              <h3 class="mb-3 text-sm font-medium text-gray-900">Media</h3>
              <div class="space-y-3">
                <div>
                  <label for="images" class="block text-sm font-medium text-gray-700">Image URLs (one per line)</label>
                  <textarea
                    id="images"
                    formControlName="images"
                    rows="3"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="https://..."
                  ></textarea>
                </div>
                <div>
                  <label for="thumbnail" class="block text-sm font-medium text-gray-700">Thumbnail URL (optional)</label>
                  <input
                    id="thumbnail"
                    type="text"
                    formControlName="thumbnail"
                    class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-500"
                    placeholder="Uses first image if empty"
                  />
                </div>
              </div>
            </section>

          </div>
        </div>

        <div class="shrink-0 border-t border-gray-200 px-6 py-4">
          <div class="flex justify-end gap-3">
            <button
              type="button"
              (click)="emitClose()"
              class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
            >
              Cancel
            </button>
            <button
              type="submit"
              [disabled]="saving()"
              class="rounded-lg bg-gray-900 px-4 py-2 text-sm font-medium text-white hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-60 disabled:cursor-not-allowed"
            >
            {{ saving() ? 'შენახვა…' : (editListing() ? 'ცვლილებების შენახვა' : 'ჩანაწერის შენახვა') }}
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
}
